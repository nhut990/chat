<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat ri√™ng Firebase</title>
<style>
body { font-family: Arial; background:#eef; text-align:center; margin:0; padding:0; }
#login, #chat { max-width:400px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px #999; }
input, button { width:90%; padding:10px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:5px; }
button { background:#4CAF50; color:white; cursor:pointer; border:none; }
button:hover { background:#45a049; }
button:disabled { background:#ccc; cursor:not-allowed; }
#messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; text-align:left; background:#fafafa; margin:10px 0; }
.msg { margin:8px 0; padding:8px 12px; clear:both; max-width:80%; word-wrap:break-word; }
.msg.left { float:left; background:#e3f2fd; border-radius:10px 10px 10px 0; }
.msg.right { float:right; background:#c8e6c9; border-radius:10px 10px 0 10px; text-align:right; }
.msg .sender { font-weight:bold; font-size:13px; margin-bottom:3px; display:block; }
.msg.left .sender { color:#1976d2; }
.msg.right .sender { color:#388e3c; }
.msg .text { font-size:15px; color:#333; }
.msg .time { font-size:11px; color:#666; margin-top:3px; display:block; }
#deleteRoom { background:#f44336; }
#deleteRoom:hover { background:#da190b; }
.loading { opacity:0.6; pointer-events:none; }
.system-msg { text-align:center; color:#999; font-size:12px; padding:5px; font-style:italic; clear:both; }
</style>
</head>
<body>

<div id="login">
  <h2>üí¨ Chat ri√™ng Online</h2>
  <button id="showGuide" style="width:auto; padding:5px 15px; font-size:14px; background:#2196F3; margin-bottom:10px;">üìñ H∆∞·ªõng d·∫´n</button>
  <input id="name" placeholder="T√™n c·ªßa b·∫°n" autocomplete="off">
  <input id="room" placeholder="T√™n ph√≤ng" autocomplete="off">
  <input id="pass" placeholder="M·∫≠t kh·∫©u" type="password">
  <button id="create">T·∫°o ph√≤ng</button>
  <button id="join">V√†o ph√≤ng</button>
  <p style="font-size:12px; color:#666;">üí° T√™n ph√≤ng v√† m·∫≠t kh·∫©u ph√¢n bi·ªát hoa th∆∞·ªùng</p>
</div>

<!-- Modal H∆∞·ªõng d·∫´n -->

<div id="guideModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; overflow:auto;">
  <div style="max-width:500px; margin:30px auto; background:white; padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    <h2 style="color:#2196F3; margin-top:0;">üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Chat ri√™ng Online</h2>
    <div style="text-align:left; line-height:1.8;">
      <h3 style="color:#4CAF50; margin-top:20px;">üè† T·∫°o ph√≤ng chat</h3>
      <p style="margin:5px 0;">1Ô∏è‚É£ Nh·∫≠p <strong>t√™n c·ªßa b·∫°n</strong></p>
      <p style="margin:5px 0;">2Ô∏è‚É£ ƒê·∫∑t <strong>t√™n ph√≤ng</strong> (v√≠ d·ª•: PhongCuaBan123)</p>
      <p style="margin:5px 0;">3Ô∏è‚É£ T·∫°o <strong>m·∫≠t kh·∫©u</strong> (t·ªëi thi·ªÉu 6 k√Ω t·ª±)</p>
      <p style="margin:5px 0;">4Ô∏è‚É£ Nh·∫•n n√∫t <strong>"T·∫°o ph√≤ng"</strong></p>
      <p style="margin:5px 0; color:#666; font-size:14px;">üí° B·∫°n l√† ng∆∞·ªùi t·∫°o ph√≤ng v√† s·∫Ω nh·∫≠n th√¥ng b√°o khi c√≥ ng∆∞·ªùi v√†o</p>

      <h3 style="color:#FF9800; margin-top:20px;">üö™ V√†o ph√≤ng c√≥ s·∫µn</h3>
      <p style="margin:5px 0;">1Ô∏è‚É£ Nh·∫≠p <strong>t√™n c·ªßa b·∫°n</strong></p>
      <p style="margin:5px 0;">2Ô∏è‚É£ Nh·∫≠p <strong>t√™n ph√≤ng</strong> (do b·∫°n b√® t·∫°o)</p>
      <p style="margin:5px 0;">3Ô∏è‚É£ Nh·∫≠p <strong>m·∫≠t kh·∫©u</strong> (h·ªèi ng∆∞·ªùi t·∫°o ph√≤ng)</p>
      <p style="margin:5px 0;">4Ô∏è‚É£ Nh·∫•n n√∫t <strong>"V√†o ph√≤ng"</strong></p>
      
      <h3 style="color:#9C27B0; margin-top:20px;">üí¨ Chat trong ph√≤ng</h3>
      <p style="margin:5px 0;">‚úÖ Tin nh·∫Øn c·ªßa b·∫°n: <span style="background:#c8e6c9; padding:3px 8px; border-radius:5px;">m√†u xanh l√°, b√™n ph·∫£i</span></p>
      <p style="margin:5px 0;">‚úÖ Tin nh·∫Øn ng∆∞·ªùi kh√°c: <span style="background:#e3f2fd; padding:3px 8px; border-radius:5px;">m√†u xanh d∆∞∆°ng, b√™n tr√°i</span></p>
      <p style="margin:5px 0;">‚úÖ Nh·∫•n <strong>Enter</strong> ho·∫∑c n√∫t <strong>"G·ª≠i"</strong> ƒë·ªÉ g·ª≠i tin</p>
      
      <h3 style="color:#f44336; margin-top:20px;">‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng</h3>
      <p style="margin:5px 0;">üîí <strong>B·∫£o m·∫≠t:</strong> T√™n ph√≤ng v√† m·∫≠t kh·∫©u ph√¢n bi·ªát HOA/th∆∞·ªùng</p>
      <p style="margin:5px 0;">üóëÔ∏è <strong>X√≥a ph√≤ng:</strong> B·∫•t k·ª≥ ai trong ph√≤ng ƒë·ªÅu c√≥ th·ªÉ x√≥a ph√≤ng</p>
      <p style="margin:5px 0;">üíæ <strong>D·ªØ li·ªáu:</strong> Khi x√≥a ph√≤ng, T·∫§T C·∫¢ tin nh·∫Øn s·∫Ω M·∫§T Vƒ®NH VI·ªÑN</p>
      <p style="margin:5px 0;">üîÑ <strong>Real-time:</strong> Tin nh·∫Øn hi·ªÉn th·ªã ngay l·∫≠p t·ª©c cho t·∫•t c·∫£ th√†nh vi√™n</p>
      <p style="margin:5px 0;">üë• <strong>Chia s·∫ª:</strong> G·ª≠i t√™n ph√≤ng + m·∫≠t kh·∫©u cho b·∫°n b√® ƒë·ªÉ h·ªç v√†o c√πng</p>
      
      <div style="background:#ffebee; border-left:4px solid #f44336; padding:12px; margin-top:20px; border-radius:5px;">
        <p style="color:#c62828; margin:0; font-size:14px; line-height:1.6;">
          <strong>‚ö†Ô∏è CAM K·∫æT V√Ä KHUY·∫æN C√ÅO:</strong><br>
          Web n√†y ƒë∆∞·ª£c t·∫°o ra v·ªõi m·ª•c ƒë√≠ch gi√∫p m·ªçi ng∆∞·ªùi tr√≤ chuy·ªán v·ªõi nhau m·ªôt c√°ch ƒë∆°n gi·∫£n nh·∫•t. Ch√∫ng t√¥i cam k·∫øt <strong>KH√îNG l∆∞u tr·ªØ, thu th·∫≠p hay s·ª≠ d·ª•ng</strong> b·∫•t k·ª≥ n·ªôi dung tr√≤ chuy·ªán n√†o c·ªßa b·∫°n. Tuy nhi√™n, ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n tuy·ªát ƒë·ªëi, ch√∫ng t√¥i <strong>KH√îNG KHUY·∫æN NGH·ªä</strong> chia s·∫ª c√°c th√¥ng tin nh·∫°y c·∫£m nh∆∞: m·∫≠t kh·∫©u t√†i kho·∫£n, s·ªë th·∫ª ng√¢n h√†ng, CMND/CCCD, t√†i li·ªáu m·∫≠t, th√¥ng tin c√° nh√¢n quan tr·ªçng ho·∫∑c b·∫•t k·ª≥ d·ªØ li·ªáu nh·∫°y c·∫£m n√†o kh√°c qua ·ª©ng d·ª•ng n√†y.
        </p>
      </div>
    </div>
    <button id="closeGuide" style="width:100%; margin-top:20px; padding:12px; background:#4CAF50; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">‚úÖ ƒê√£ hi·ªÉu</button>
  </div>
</div>

<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <input id="msgBox" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
  <button id="send">G·ª≠i</button>
  <br><br>
  <button id="leave" style="background:#FF9800;">R·ªùi ph√≤ng</button>
  <button id="deleteRoom" style="background:#f44336;">Xo√° ph√≤ng</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const firebaseConfig = {
    databaseURL: "https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let myName, roomName, myPass, isCreator = false;
  let messageListener = null;
  let memberListener = null;
  let roomDeletionListener = null;

  // X·ª≠ l√Ω modal h∆∞·ªõng d·∫´n
  document.getElementById("showGuide").onclick = () => {
    document.getElementById("guideModal").style.display = "block";
  };

  document.getElementById("closeGuide").onclick = () => {
    document.getElementById("guideModal").style.display = "none";
  };

  document.getElementById("guideModal").onclick = (e) => {
    if (e.target.id === "guideModal") {
      document.getElementById("guideModal").style.display = "none";
    }
  };

  // H√†m hash m·∫≠t kh·∫©u
  async function hashPassword(password) {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // H√†m escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // T·∫°o ph√≤ng
  document.getElementById("create").onclick = async () => {
    const btn = document.getElementById("create");
    try {
      btn.disabled = true;
      btn.textContent = "ƒêang t·∫°o...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        return;
      }

      if (myPass.length < 6) {
        alert("‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (snap.exists()) {
        alert("‚ö†Ô∏è Ph√≤ng ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn t√™n kh√°c.");
        return;
      }

      const hashedPass = await hashPassword(myPass);
      await rRef.set({ 
        password: hashedPass,
        creator: myName,
        createdAt: new Date().toISOString()
      });

      // Th√™m ng∆∞·ªùi t·∫°o v√†o danh s√°ch th√†nh vi√™n
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = true;
      startChat();

    } catch (error) {
      console.error("L·ªói t·∫°o ph√≤ng:", error);
      alert("‚ùå L·ªói: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "T·∫°o ph√≤ng";
    }
  };

  // V√†o ph√≤ng
  document.getElementById("join").onclick = async () => {
    const btn = document.getElementById("join");
    try {
      btn.disabled = true;
      btn.textContent = "ƒêang k·∫øt n·ªëi...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (!snap.exists()) {
        alert("‚ö†Ô∏è Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
        return;
      }

      const hashedPass = await hashPassword(myPass);
      if (snap.val().password !== hashedPass) {
        alert("‚ùå Sai m·∫≠t kh·∫©u!");
        return;
      }

      // Th√™m th√†nh vi√™n m·ªõi v√†o ph√≤ng
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = false;
      startChat();

    } catch (error) {
      console.error("L·ªói v√†o ph√≤ng:", error);
      alert("‚ùå L·ªói: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "V√†o ph√≤ng";
    }
  };

  // B·∫Øt ƒë·∫ßu chat
  function startChat() {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("roomTitle").textContent = "üè† Ph√≤ng: " + roomName;
    loadMessages();
    listenForNewMembers();
    listenForRoomDeletion();
  }

  // L·∫Øng nghe th√†nh vi√™n m·ªõi
  function listenForNewMembers() {
    const membersRef = db.ref("rooms/" + roomName + "/members");
    let knownMembers = new Set();
    let isFirstLoad = true;

    // Load danh s√°ch th√†nh vi√™n hi·ªán t·∫°i
    membersRef.once("value").then((snapshot) => {
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          knownMembers.add(child.val().name);
        });
      }
      isFirstLoad = false;
    });

    // L·∫Øng nghe th√†nh vi√™n m·ªõi
    memberListener = membersRef.on("child_added", (snapshot) => {
      if (!isFirstLoad) {
        const memberName = snapshot.val().name;
        
        // Ch·ªâ th√¥ng b√°o n·∫øu kh√¥ng ph·∫£i l√† m√¨nh v√† ch∆∞a c√≥ trong danh s√°ch
        if (memberName !== myName && !knownMembers.has(memberName)) {
          const messagesDiv = document.getElementById("messages");
          const systemMsg = document.createElement("div");
          systemMsg.className = "system-msg";
          systemMsg.textContent = `üëã ${memberName} ƒë√£ v√†o ph√≤ng`;
          messagesDiv.appendChild(systemMsg);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        knownMembers.add(memberName);
      }
    });
  }

  // L·∫Øng nghe khi ph√≤ng b·ªã x√≥a
  function listenForRoomDeletion() {
    const roomRef = db.ref("rooms/" + roomName);
    
    roomDeletionListener = roomRef.on("value", (snapshot) => {
      // N·∫øu ph√≤ng kh√¥ng c√≤n t·ªìn t·∫°i
      if (!snapshot.exists()) {
        // T·∫Øt t·∫•t c·∫£ listeners
        if (messageListener) {
          db.ref("rooms/" + roomName + "/messages").off("value", messageListener);
          messageListener = null;
        }
        if (memberListener) {
          db.ref("rooms/" + roomName + "/members").off("child_added", memberListener);
          memberListener = null;
        }
        if (roomDeletionListener) {
          roomRef.off("value", roomDeletionListener);
          roomDeletionListener = null;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        alert("‚ö†Ô∏è PH√íNG ƒê√É B·ªä X√ìA\n\nPh√≤ng chat n√†y ƒë√£ b·ªã x√≥a b·ªüi m·ªôt th√†nh vi√™n kh√°c.\n\nB·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ trang ch·ªß.");
        location.reload();
      }
    });
  }

  // G·ª≠i tin nh·∫Øn
  document.getElementById("send").onclick = sendMessage;
  document.getElementById("msgBox").onkeypress = function(e) {
    if (e.key === 'Enter') sendMessage();
  };

  async function sendMessage() {
    const msgBox = document.getElementById("msgBox");
    const text = msgBox.value.trim();
    if (!text) return;

    try {
      const msgRef = db.ref("rooms/" + roomName + "/messages");
      await msgRef.push({
        sender: myName,
        text: text,
        time: new Date().toISOString()
      });
      msgBox.value = "";
    } catch (error) {
      console.error("L·ªói g·ª≠i tin:", error);
      alert("‚ùå Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn: " + error.message);
    }
  }

  // Load tin nh·∫Øn
  function loadMessages() {
    const msgRef = db.ref("rooms/" + roomName + "/messages");
    
    if (messageListener) {
      msgRef.off("value", messageListener);
    }

    messageListener = msgRef.on("value", (snap) => {
      const messagesDiv = document.getElementById("messages");
      // L∆∞u c√°c tin nh·∫Øn h·ªá th·ªëng hi·ªán c√≥
      const systemMessages = Array.from(messagesDiv.querySelectorAll('.system-msg'));
      
      messagesDiv.innerHTML = "";
      
      if (!snap.exists() || !snap.val()) {
        messagesDiv.innerHTML = "<p style='color:#999;text-align:center;'>Ch∆∞a c√≥ tin nh·∫Øn n√†o...</p>";
        return;
      }

      snap.forEach(child => {
        const m = child.val();
        const div = document.createElement("div");
        
        // Tin c·ªßa m√¨nh b√™n PH·∫¢I (xanh l√°), ng∆∞·ªùi kh√°c b√™n TR√ÅI (xanh d∆∞∆°ng)
        const isMyMessage = m.sender === myName;
        div.className = isMyMessage ? "msg right" : "msg left";
        
        const time = new Date(m.time).toLocaleString('vi-VN', {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: '2-digit'
        });
        
        div.innerHTML = `
          <span class="sender">${escapeHtml(m.sender)}</span>
          <span class="text">${escapeHtml(m.text)}</span>
          <span class="time">${time}</span>
        `;
        messagesDiv.appendChild(div);
      });
      
      // Th√™m l·∫°i c√°c tin nh·∫Øn h·ªá th·ªëng
      systemMessages.forEach(msg => messagesDiv.appendChild(msg));
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // X√≥a ph√≤ng
  document.getElementById("deleteRoom").onclick = async () => {
    if (confirm("‚ö†Ô∏è X√ìA PH√íNG CHAT\n\nB·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng n√†y?\n\n‚Ä¢ Ph√≤ng \"" + roomName + "\" s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn\n‚Ä¢ T·∫•t c·∫£ tin nh·∫Øn s·∫Ω b·ªã m·∫•t\n‚Ä¢ M·ªçi ng∆∞·ªùi s·∫Ω b·ªã ng·∫Øt k·∫øt n·ªëi\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!")) {
      try {
        const btn = document.getElementById("deleteRoom");
        btn.disabled = true;
        btn.textContent = "ƒêang x√≥a...";

        // G·ª≠i th√¥ng b√°o x√≥a ph√≤ng tr∆∞·ªõc khi x√≥a
        const msgRef = db.ref("rooms/" + roomName + "/messages");
        await msgRef.push({
          sender: "H·ªá th·ªëng",
          text: "üóëÔ∏è " + myName + " ƒë√£ x√≥a ph√≤ng chat n√†y",
          time: new Date().toISOString(),
          isSystemMessage: true
        });

        // ƒê·ª£i 1 gi√¢y ƒë·ªÉ ng∆∞·ªùi kh√°c nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o
        await new Promise(resolve => setTimeout(resolve, 1000));

        // T·∫Øt t·∫•t c·∫£ listeners
        if (messageListener) {
          msgRef.off("value", messageListener);
          messageListener = null;
        }
        if (memberListener) {
          db.ref("rooms/" + roomName + "/members").off("child_added", memberListener);
          memberListener = null;
        }
        if (roomDeletionListener) {
          db.ref("rooms/" + roomName).off("value", roomDeletionListener);
          roomDeletionListener = null;
        }
        
        // X√≥a ph√≤ng
        await db.ref("rooms/" + roomName).remove();
        
        alert("‚úÖ ƒê√£ x√≥a ph√≤ng v√† t·∫•t c·∫£ tin nh·∫Øn th√†nh c√¥ng!");
        location.reload();
      } catch (error) {
        console.error("L·ªói x√≥a ph√≤ng:", error);
        alert("‚ùå Kh√¥ng th·ªÉ x√≥a ph√≤ng: " + error.message);
        document.getElementById("deleteRoom").disabled = false;
        document.getElementById("deleteRoom").textContent = "Xo√° ph√≤ng";
      }
    }
  };

  // R·ªùi ph√≤ng
  document.getElementById("leave").onclick = async () => {
    if (confirm("B·∫°n mu·ªën r·ªùi kh·ªèi ph√≤ng?")) {
      try {
        // X√≥a kh·ªèi danh s√°ch members
        await db.ref("rooms/" + roomName + "/members/" + myName).remove();
        
        // T·∫Øt listeners
        if (messageListener) {
          db.ref("rooms/" + roomName + "/messages").off("value", messageListener);
          messageListener = null;
        }
        if (memberListener) {
          db.ref("rooms/" + roomName + "/members").off("child_added", memberListener);
          memberListener = null;
        }
        if (roomDeletionListener) {
          db.ref("rooms/" + roomName).off("value", roomDeletionListener);
          roomDeletionListener = null;
        }
        
        location.reload();
      } catch (error) {
        console.error("L·ªói r·ªùi ph√≤ng:", error);
        location.reload();
      }
    }
  };
});
</script>

</body>
</html>
